#!/bin/bash
#
#
# Get function from functions library
. /etc/init.d/functions
# Start the service BDRE
USER=%USER%
BDRE_HOME=~$USER/bdre
BDRE_APPS_HOME=~$USER/bdre_apps

DAEMON=$BDRE_HOME/bdre-scripts/bin/run-ui.sh # Introduce the bdre's location here
LOGDIR=/var/log/BDRE  # Log directory to use
PIDFILE=/var/run/BDRE/bdre.pid

DAEMON_OPTS="$LOGDIR"
BDRE_SHUTDOWN_TIMEOUT=15


start() {
        echo -n "Starting bdre: "
        pid_dir=$(dirname $PIDFILE)
        mkdir -p $pid_dir
        chown -R $USER $pid_dir

	# Check if already running
        if [ -f $PIDFILE ]; then
            pid=`cat $PIDFILE`
            echo PIDFILE found with pid $pid
            returnPid=`ps -o pid= -p $pid`
            if [ -n $returnPid ];then
                echo "BDRE already running with pid $returnPid"
                return 0
            fi
        fi
        echo "su $USER -c \"$DAEMON $DAEMON_OPTS/service.log & echo $!\""
        new_pid=`su $USER -c "$DAEMON $DAEMON_OPTS/service.log & echo $!"`
	    ret=$?
        base=$(basename $0)
        if [ $ret -eq 0 ]; then
            echo $new_pid > $PIDFILE
            echo "BDRE UI Started with PID $new_pid"
        fi
        return $ret

}
# Restart the service bdre
stop() {
	 if [ ! -f $PIDFILE ]; then
            success "bdre is not running"
            return 0
        fi

        echo -n "Shutting down bdre: "

        bdre_pid=`cat $PIDFILE`
        if [ -n "$bdre_pid" ]; then
          kill -TERM ${bdre_pid} &>/dev/null
          for i in `seq 1 ${BDRE_SHUTDOWN_TIMEOUT}` ; do
            kill -0 ${bdre_pid} &>/dev/null || break
            sleep 1
          done
          kill -KILL ${bdre_pid} &>/dev/null
        fi
        echo
        rm -f $PIDFILE
        return 0
}

restart() {
  stop
  start
}

### main logic ###
case "$1" in
  start)
        start
        ;;
  stop)
        stop
        ;;
  status)
        status -p $PIDFILE bdre
        ;;
  restart)
        restart
        ;;
    *)
        echo "Usage: bdre {start|stop|status|restart"
        exit 1
        ;;

esac
exit $?